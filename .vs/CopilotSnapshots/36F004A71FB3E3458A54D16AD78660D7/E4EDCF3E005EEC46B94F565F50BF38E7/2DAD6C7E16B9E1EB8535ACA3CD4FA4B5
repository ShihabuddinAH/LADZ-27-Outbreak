using UnityEngine;
using UnityEngine.UI;
using UnityEngine.SceneManagement;
using TMPro;

/// <summary>
/// Game Over Panel dengan input nama untuk leaderboard.
/// </summary>
public class GameOverPanel : MonoBehaviour
{
    [Header("Stats Display")]
    [SerializeField] private TextMeshProUGUI finalScoreText;
    [SerializeField] private TextMeshProUGUI finalKillsText;
    [SerializeField] private TextMeshProUGUI finalTimeText;
    [SerializeField] private TextMeshProUGUI finalWaveText;
    
    [Header("Leaderboard Input")]
    [SerializeField] private GameObject nameInputPanel;
    [SerializeField] private TMP_InputField nameInput;
    [SerializeField] private Button submitButton;
    [SerializeField] private TextMeshProUGUI rankText;
    
    [Header("Buttons")]
    [SerializeField] private Button restartButton;
    [SerializeField] private Button quitButton;
    
    [Header("Settings")]
    [SerializeField] private bool alwaysShowInput = true;
    
    [Header("Format")]
    [SerializeField] private string scoreFormat = "SCORE: {0}";
    [SerializeField] private string killsFormat = "KILLS: {0}";
    [SerializeField] private string timeFormat = "TIME: {0}";
    [SerializeField] private string waveFormat = "WAVE: {0}";
    
    private bool hasSubmitted = false;
    private bool isInitialized = false;
    
    void Awake()
    {
        // Setup button listeners di Awake (lebih awal dari Start)
        if (submitButton != null)
            submitButton.onClick.AddListener(OnSubmitName);
        
        if (restartButton != null)
            restartButton.onClick.AddListener(OnRestart);
        
        if (quitButton != null)
            quitButton.onClick.AddListener(OnQuit);
        
        isInitialized = true;
    }
    
    void OnEnable()
    {
        // Reset state
        hasSubmitted = false;
        
        if (submitButton != null)
            submitButton.interactable = true;
        
        // Update stats
        UpdateStats();
        
        // Show input panel
        if (alwaysShowInput)
        {
            ShowInputPanel();
        }
    }
    
    private void UpdateStats()
    {
        if (GameStats.Instance == null) return;
        
        if (finalScoreText != null)
            finalScoreText.text = string.Format(scoreFormat, GameStats.Instance.GetScore());
        
        if (finalKillsText != null)
            finalKillsText.text = string.Format(killsFormat, GameStats.Instance.GetKills());
        
        if (finalTimeText != null)
            finalTimeText.text = string.Format(timeFormat, GameStats.Instance.GetFormattedTime());
        
        if (finalWaveText != null)
            finalWaveText.text = string.Format(waveFormat, GameStats.Instance.GetCurrentWave());
    }
    
    private void ShowInputPanel()
    {
        if (nameInputPanel == null)
        {
            Debug.LogWarning("[GameOverPanel] nameInputPanel is NULL!");
            return;
        }
        
        nameInputPanel.SetActive(true);
        Debug.Log("[GameOverPanel] NameInputPanel activated");
        
        if (nameInput != null)
        {
            nameInput.text = "";
            nameInput.Select();
            nameInput.ActivateInputField();
        }
        
        if (rankText != null)
            rankText.text = "Enter Your Name:";
    }
    
    public void OnSubmitName()
    {
        if (hasSubmitted) return;
        
        string playerName = "Anonymous";
        
        if (nameInput != null)
        {
            playerName = nameInput.text.Trim();
            if (string.IsNullOrEmpty(playerName))
                playerName = "Anonymous";
            if (playerName.Length > 20)
                playerName = playerName.Substring(0, 20);
        }
        
        hasSubmitted = true;
        
        if (submitButton != null)
            submitButton.interactable = false;
        
        // Save to leaderboard if available
        if (LeaderboardManager.Instance != null && GameStats.Instance != null)
        {
            LeaderboardManager.Instance.AddEntry(
                playerName,
                GameStats.Instance.GetScore(),
                GameStats.Instance.GetKills(),
                GameStats.Instance.GetSurvivalTime(),
                GameStats.Instance.GetCurrentWave()
            );
            Debug.Log($"[GameOverPanel] Score saved! Player: {playerName}");
        }
        
        // Hide input panel
        if (nameInputPanel != null)
            nameInputPanel.SetActive(false);
        
        if (rankText != null)
            rankText.text = "Score Saved!";
    }
    
    public void OnRestart()
    {
        Debug.Log("[GameOverPanel] Restart clicked");
        Time.timeScale = 1f;
        SceneManager.LoadScene(SceneManager.GetActiveScene().name);
    }
    
    public void OnQuit()
    {
        Debug.Log("[GameOverPanel] Quit clicked");
        Time.timeScale = 1f;
        SceneManager.LoadScene("MainMenu");
    }
}
