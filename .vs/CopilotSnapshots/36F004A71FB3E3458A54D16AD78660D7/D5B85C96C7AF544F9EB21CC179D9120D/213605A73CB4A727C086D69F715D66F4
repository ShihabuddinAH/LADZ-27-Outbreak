using UnityEngine;
using UnityEngine.UI;

/// <summary>
/// Audio Settings Controller untuk Settings Menu
/// Kontrol volume BGM dan SFX dengan slider
/// </summary>
public class AudioSettings : MonoBehaviour
{
    [Header("UI References")]
    [SerializeField] private Slider musicVolumeSlider;
    [SerializeField] private Slider sfxVolumeSlider;
    [SerializeField] private Toggle musicMuteToggle;
    [SerializeField] private Toggle sfxMuteToggle;
    
    [Header("Optional Text Display")]
    [SerializeField] private TMPro.TextMeshProUGUI musicVolumeText;
    [SerializeField] private TMPro.TextMeshProUGUI sfxVolumeText;
    
    void Start()
    {
        // Setup sliders
        if (musicVolumeSlider != null)
        {
            musicVolumeSlider.minValue = 0f;
            musicVolumeSlider.maxValue = 1f;
            musicVolumeSlider.onValueChanged.AddListener(OnMusicVolumeChanged);
        }
        
        if (sfxVolumeSlider != null)
        {
            sfxVolumeSlider.minValue = 0f;
            sfxVolumeSlider.maxValue = 1f;
            sfxVolumeSlider.onValueChanged.AddListener(OnSFXVolumeChanged);
        }
        
        // Setup toggles
        if (musicMuteToggle != null)
        {
            musicMuteToggle.onValueChanged.AddListener(OnMusicMuteToggled);
        }
        
        if (sfxMuteToggle != null)
        {
            sfxMuteToggle.onValueChanged.AddListener(OnSFXMuteToggled);
        }
        
        // Load saved settings
        LoadSettings();
    }
    
    void OnEnable()
    {
        // Refresh UI saat panel dibuka
        LoadSettings();
    }
    
    private void LoadSettings()
    {
        // Load Music settings
        if (MusicManager.Instance != null)
        {
            float musicVolume = MusicManager.Instance.GetVolume();
            
            if (musicVolumeSlider != null)
            {
                musicVolumeSlider.SetValueWithoutNotify(musicVolume);
            }
            
            UpdateMusicVolumeText(musicVolume);
            
            if (musicMuteToggle != null)
            {
                musicMuteToggle.SetIsOnWithoutNotify(MusicManager.Instance.IsMuted());
            }
        }
        
        // Load SFX settings
        if (SFXManager.Instance != null)
        {
            float sfxVolume = SFXManager.Instance.GetVolume();
            
            if (sfxVolumeSlider != null)
            {
                sfxVolumeSlider.SetValueWithoutNotify(sfxVolume);
            }
            
            UpdateSFXVolumeText(sfxVolume);
        }
    }
    
    /// <summary>
    /// Dipanggil saat music volume slider berubah
    /// </summary>
    public void OnMusicVolumeChanged(float value)
    {
        if (MusicManager.Instance != null)
        {
            MusicManager.Instance.SetVolume(value);
        }
        
        UpdateMusicVolumeText(value);
    }
    
    /// <summary>
    /// Dipanggil saat SFX volume slider berubah
    /// </summary>
    public void OnSFXVolumeChanged(float value)
    {
        if (SFXManager.Instance != null)
        {
            SFXManager.Instance.SetVolume(value);
        }
        
        UpdateSFXVolumeText(value);
        
        // Play test SFX untuk preview
        if (SFXManager.Instance != null)
        {
            SFXManager.Instance.PlayButtonClick();
        }
    }
    
    /// <summary>
    /// Dipanggil saat music mute toggle berubah
    /// </summary>
    public void OnMusicMuteToggled(bool isMuted)
    {
        if (MusicManager.Instance != null)
        {
            MusicManager.Instance.SetMute(isMuted);
        }
    }
    
    /// <summary>
    /// Dipanggil saat SFX mute toggle berubah
    /// </summary>
    public void OnSFXMuteToggled(bool isMuted)
    {
        if (SFXManager.Instance != null)
        {
            SFXManager.Instance.SetMute(isMuted);
        }
    }
    
    private void UpdateMusicVolumeText(float volume)
    {
        if (musicVolumeText != null)
        {
            musicVolumeText.text = $"{Mathf.RoundToInt(volume * 100)}%";
        }
    }
    
    private void UpdateSFXVolumeText(float volume)
    {
        if (sfxVolumeText != null)
        {
            sfxVolumeText.text = $"{Mathf.RoundToInt(volume * 100)}%";
        }
    }
    
    /// <summary>
    /// Reset audio settings ke default
    /// </summary>
    public void ResetToDefault()
    {
        if (musicVolumeSlider != null)
        {
            musicVolumeSlider.value = 0.5f;
        }
        
        if (sfxVolumeSlider != null)
        {
            sfxVolumeSlider.value = 0.7f;
        }
        
        if (musicMuteToggle != null)
        {
            musicMuteToggle.isOn = false;
        }
        
        if (sfxMuteToggle != null)
        {
            sfxMuteToggle.isOn = false;
        }
    }
}
