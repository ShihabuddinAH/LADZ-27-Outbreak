using UnityEngine;

public class ZombieMovement : MonoBehaviour
{
    [Header("Movement Settings")]
    [SerializeField] private float kecepatan = 2f; // Kecepatan zombie mengejar
    [SerializeField] private float jarakBerhenti = 1.5f; // Jarak minimum untuk berhenti mengejar

    [Header("Detection Settings")]
    [SerializeField] private float detectionRange = 10f; // Jarak deteksi player
    [SerializeField] private bool showDetectionRadius = true; // Tampilkan detection radius di Scene view

    [Header("Attack Settings")]
    [SerializeField] private float attackRange = 2f; // Jarak untuk menyerang (diperbesar)
    [SerializeField] private float attackCooldown = 1f; // Cooldown antara serangan (detik)
    [SerializeField] private int attackDamage = 10; // Damage yang diberikan ke player
    [SerializeField] private float attackDuration = 0.5f; // Durasi animasi attack
    
    [Header("Components")]
    [SerializeField] private Animator animator; // Animator zombie

    private Transform target; // Target player
    private bool isChasing = false; // Flag untuk mengecek apakah sudah ter-trigger untuk mengejar
    private bool isAttacking = false; // Flag untuk freeze movement saat attack
    private float lastAttackTime = -999f; // Waktu serangan terakhir

    void Start()
    {

    }

    void Update()
    {
        // Jika sedang attacking, jangan update movement
        if (isAttacking)
        {
            return;
        }

        // Cari pemain jika target belum diset
        if (target == null)
        {
            GameObject player = GameObject.FindGameObjectWithTag("Player");
            if (player != null)
            {
                target = player.transform;
            }
            return;
        }

        // Hitung jarak antara zombie dan pemain
        float jarak = Vector3.Distance(transform.position, target.position);

        // Cek apakah player masuk detection range (trigger chase)
        if (!isChasing && jarak <= detectionRange)
        {
            isChasing = true;
        }

        // Jika sudah ter-trigger, terus kejar player
        if (isChasing)
        {
            // Cek apakah dalam jarak serang
            if (jarak <= attackRange && Time.time >= lastAttackTime + attackCooldown)
            {
                TryAttackPlayer();
            }
            else
            {
                ChasePlayer(jarak);
            }
        }
        else
        {
            // Idle jika belum ter-trigger
            if (animator != null)
            {
                animator.SetBool("isRunning", false);
            }
        }
    }

    private void ChasePlayer(float jarak)
    {
        // Jika jarak lebih besar dari jarak berhenti, kejar pemain
        if (jarak > jarakBerhenti)
        {
            // Set animasi berjalan jika ada animator
            if (animator != null)
            {
                animator.SetBool("isRunning", true);
            }

            // Gerakkan zombie menuju pemain
            Vector3 arah = (target.position - transform.position).normalized;
            transform.position += arah * kecepatan * Time.deltaTime;

            // Rotasi zombie menghadap pemain
            RotateTowardsTarget(arah);
        }
        else
        {
            // Set animasi idle jika dekat dengan pemain
            if (animator != null)
            {
                animator.SetBool("isRunning", false);
            }
            
            // Tetap menghadap player meskipun tidak bergerak
            Vector3 arah = (target.position - transform.position).normalized;
            RotateTowardsTarget(arah);
        }
    }

    private void TryAttackPlayer()
    {
        // Berhenti bergerak
        if (animator != null)
        {
            animator.SetBool("isRunning", false);
        }

        // Tetap menghadap player
        if (target != null)
        {
            Vector3 arah = (target.position - transform.position).normalized;
            RotateTowardsTarget(arah);
        }

        // Perform attack
        PerformAttack();
    }

    private void PerformAttack()
    {
        // Set flag attacking untuk freeze movement
        isAttacking = true;
        lastAttackTime = Time.time;

        // Trigger animasi attack
        if (animator != null)
        {
            animator.SetTrigger("isAttack");
        }

        // Berikan damage ke player
        DealDamageToPlayer();

        // Invoke unfreeze setelah durasi attack
        Invoke("UnfreezeMovement", attackDuration);
    }

    private void UnfreezeMovement()
    {
        isAttacking = false;
    }

    private void DealDamageToPlayer()
    {
        if (target != null)
        {
            PlayerHealth playerHealth = target.GetComponent<PlayerHealth>();
            if (playerHealth != null)
            {
                playerHealth.TakeDamage(attackDamage);
            }
        }
    }

    void RotateTowardsTarget(Vector3 arah)
    {
        // Hitung sudut rotasi berdasarkan arah
        float angle = Mathf.Atan2(arah.y, arah.x) * Mathf.Rad2Deg;
        transform.rotation = Quaternion.Euler(0f, 0f, angle);
    }

    // Method untuk reset chase state (opsional, untuk gameplay mechanic tertentu)
    public void ResetChaseState()
    {
        isChasing = false;
    }

    // Callback dari collision/trigger untuk attack (seperti Enemy.cs lama)
    private void OnCollisionStay2D(Collision2D collision)
    {
        if (collision.gameObject.CompareTag("Player") && !isAttacking)
        {
            if (Time.time >= lastAttackTime + attackCooldown)
            {
                target = collision.transform;
                PerformAttack();
            }
        }
    }

    private void OnTriggerStay2D(Collider2D other)
    {
        if (other.CompareTag("Player") && !isAttacking)
        {
            if (Time.time >= lastAttackTime + attackCooldown)
            {
                target = other.transform;
                PerformAttack();
            }
        }
    }

    // Visualisasi detection range di Scene view (hanya untuk development)
    private void OnDrawGizmosSelected()
    {
        if (showDetectionRadius)
        {
            // Warna hijau untuk detection range
            Gizmos.color = Color.green;
            Gizmos.DrawWireSphere(transform.position, detectionRange);

            // Warna kuning untuk attack range
            Gizmos.color = Color.yellow;
            Gizmos.DrawWireSphere(transform.position, attackRange);

            // Warna merah untuk jarak berhenti
            Gizmos.color = Color.red;
            Gizmos.DrawWireSphere(transform.position, jarakBerhenti);

            // Label
#if UNITY_EDITOR
            UnityEditor.Handles.Label(transform.position + Vector3.up * 2f,
                $"Detection: {detectionRange}m\nAttack: {attackRange}m\nStop: {jarakBerhenti}m");
#endif
        }
    }
}
