using UnityEngine;
using UnityEngine.UI;
using TMPro;
using System.Collections.Generic;

/// <summary>
/// Leaderboard Panel UI - Display scores di template static.
/// Support flexible number of entries (7, 10, atau berapapun).
/// </summary>
public class LeaderboardPanelUI : MonoBehaviour
{
    [Header("Fixed Entry References")]
    [Tooltip("Assign semua entry yang ada di template (7, 10, atau berapapun)")]
    [SerializeField] private LeaderboardEntry1to10[] entries = new LeaderboardEntry1to10[10];
    
    [Header("Buttons")]
    [SerializeField] private Button backButton;
    [SerializeField] private Button clearButton; // Clear leaderboard (optional)
    
    [Header("Settings")]
    [SerializeField] private bool showClearButton = false; // Hide in production
    [SerializeField] private bool showDeleteButtons = true; // Show delete buttons
    
    [Header("Confirmation Dialog (Optional)")]
    [SerializeField] private GameObject confirmDialog;
    [SerializeField] private TextMeshProUGUI confirmText;
    [SerializeField] private Button confirmYesButton;
    [SerializeField] private Button confirmNoButton;
    
    private int pendingDeleteIndex = -1;
    
    [System.Serializable]
    public class LeaderboardEntry1to10
    {
        public TextMeshProUGUI rankText;
        public TextMeshProUGUI nameText;
        public TextMeshProUGUI scoreText;
        public TextMeshProUGUI killsText;
        public Button deleteButton;
    }
    
    void Start()
    {
        // Setup buttons
        if (backButton != null)
            backButton.onClick.AddListener(OnBackButton);
        
        if (clearButton != null)
        {
            clearButton.onClick.AddListener(OnClearLeaderboard);
            clearButton.gameObject.SetActive(showClearButton);
        }
        
        // Setup delete buttons untuk setiap entry
        for (int i = 0; i < entries.Length; i++)
        {
            if (entries[i] != null && entries[i].deleteButton != null)
            {
                int index = i; // Capture untuk closure
                entries[i].deleteButton.onClick.AddListener(() => OnDeleteEntry(index));
                entries[i].deleteButton.gameObject.SetActive(showDeleteButtons);
            }
        }
        
        // Setup confirmation dialog
        if (confirmYesButton != null)
            confirmYesButton.onClick.AddListener(OnConfirmDelete);
        
        if (confirmNoButton != null)
            confirmNoButton.onClick.AddListener(OnCancelDelete);
        
        if (confirmDialog != null)
            confirmDialog.SetActive(false);
    }
    
    void OnEnable()
    {
        // Refresh when panel opens
        RefreshLeaderboard();
    }
    
    public void RefreshLeaderboard()
    {
        List<LeaderboardEntry> leaderboardEntries = new List<LeaderboardEntry>();
        
        // Get leaderboard data
        if (LeaderboardManager.Instance != null)
        {
            // Get as many entries as we have slots
            int maxEntries = CountAssignedEntries();
            leaderboardEntries = LeaderboardManager.Instance.GetTopEntries(maxEntries);
            
            Debug.Log($"Leaderboard loaded {leaderboardEntries.Count} entries");
        }
        else
        {
            Debug.LogWarning("LeaderboardManager.Instance is null!");
        }
        
        // Update all assigned entry slots
        int entryIndex = 0;
        for (int i = 0; i < entries.Length; i++)
        {
            var entry = entries[i];
            
            // Skip null or incomplete entries
            if (entry == null || entry.nameText == null || entry.scoreText == null)
            {
                continue;
            }
            
            if (entryIndex < leaderboardEntries.Count)
            {
                // Ada data - tampilkan data asli
                LeaderboardEntry data = leaderboardEntries[entryIndex];
                UpdateEntry(entry, entryIndex + 1, data.playerName, data.score, data.kills, true);
            }
            else
            {
                // Tidak ada data - tampilkan default
                UpdateEntry(entry, entryIndex + 1, "---", 0, 0, false);
            }
            
            entryIndex++;
        }
    }
    
    private void UpdateEntry(LeaderboardEntry1to10 entry, int rank, string playerName, int score, int kills, bool hasData)
    {
        // Update rank
        if (entry.rankText != null)
        {
            entry.rankText.text = $"#{rank}";
        }
        
        // Update name
        if (entry.nameText != null)
        {
            entry.nameText.text = playerName;
        }
        
        // Update score
        if (entry.scoreText != null)
        {
            entry.scoreText.text = hasData ? score.ToString() : "---";
        }
        
        // Update kills
        if (entry.killsText != null)
        {
            entry.killsText.text = hasData ? kills.ToString() : "---";
        }
        
        // Sembunyikan delete button jika tidak ada data
        if (entry.deleteButton != null)
        {
            entry.deleteButton.gameObject.SetActive(showDeleteButtons && hasData);
        }
    }
    
    private int CountAssignedEntries()
    {
        int count = 0;
        foreach (var entry in entries)
        {
            if (entry != null && entry.nameText != null && entry.scoreText != null)
            {
                count++;
            }
        }
        return count;
    }
    
    /// <summary>
    /// Dipanggil saat delete button diklik
    /// </summary>
    private void OnDeleteEntry(int index)
    {
        pendingDeleteIndex = index;
        
        // Jika ada confirmation dialog, tampilkan
        if (confirmDialog != null)
        {
            if (confirmText != null && entries[index] != null && entries[index].nameText != null)
            {
                confirmText.text = $"Delete entry:\n{entries[index].nameText.text}?";
            }
            confirmDialog.SetActive(true);
        }
        else
        {
            // Langsung hapus tanpa konfirmasi
            ConfirmDeleteEntry(index);
        }
    }
    
    private void OnConfirmDelete()
    {
        if (pendingDeleteIndex >= 0)
        {
            ConfirmDeleteEntry(pendingDeleteIndex);
        }
        
        if (confirmDialog != null)
            confirmDialog.SetActive(false);
        
        pendingDeleteIndex = -1;
    }
    
    private void OnCancelDelete()
    {
        pendingDeleteIndex = -1;
        
        if (confirmDialog != null)
            confirmDialog.SetActive(false);
    }
    
    private void ConfirmDeleteEntry(int index)
    {
        if (LeaderboardManager.Instance != null)
        {
            bool deleted = LeaderboardManager.Instance.DeleteEntry(index);
            
            if (deleted)
            {
                Debug.Log($"[LeaderboardPanelUI] Entry #{index + 1} deleted");
                RefreshLeaderboard();
            }
        }
    }
    
    private void OnClearLeaderboard()
    {
        if (LeaderboardManager.Instance != null)
        {
            LeaderboardManager.Instance.ClearLeaderboard();
            RefreshLeaderboard();
            Debug.Log("Leaderboard cleared!");
        }
    }
    
    private void OnBackButton()
    {
        // Return to main menu
        MainMenuManager menuManager = FindObjectOfType<MainMenuManager>();
        if (menuManager != null)
        {
            menuManager.ShowMainMenu();
        }
    }
    
    /// <summary>
    /// Manual refresh untuk testing
    /// </summary>
    [ContextMenu("Refresh Leaderboard Now")]
    public void ManualRefresh()
    {
        RefreshLeaderboard();
    }
}
