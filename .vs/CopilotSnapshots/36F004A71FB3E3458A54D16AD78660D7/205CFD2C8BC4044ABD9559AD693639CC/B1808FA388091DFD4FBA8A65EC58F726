using UnityEngine;
using System; // Tambah ini untuk Action/Events

public class WeaponController : MonoBehaviour
{
    // NEW: Events untuk UI updates
    public event Action<WeaponType, int> OnReserveAmmoChanged; // WeaponType, newReserveAmmo
    public event Action<WeaponData> OnWeaponSwitched; // WeaponData
    public event Action<int> OnCurrentAmmoChanged; // currentAmmo
    
    [Header("Current Weapon")]
    [SerializeField] private WeaponData currentWeapon;
    
    [Header("Components")]
    [SerializeField] private Animator animator;
    [SerializeField] private Transform firePoint; // Titik tembak (optional, untuk visual effect)
    [SerializeField] private LayerMask bulletHitLayers; // Layer yang bisa di-hit bullet (Enemy, Wall, dll)
    
    [Header("Bullet System")]
    [SerializeField] private GameObject bulletPrefab; // Prefab bullet universal untuk semua weapon
    [SerializeField] private bool usePhysicalBullets = true; // True = spawn bullet, False = raycast only
    
    [Header("Muzzle Flash System")]
    [SerializeField] private GameObject handgunMuzzleFlash; // Muzzle flash untuk Handgun
    [SerializeField] private GameObject rifleMuzzleFlash; // Muzzle flash untuk Rifle
    [SerializeField] private GameObject shotgunMuzzleFlash; // Muzzle flash untuk Shotgun
    
    [Header("Weapon Inventory")]
    [SerializeField] private WeaponData handgunData;
    [SerializeField] private WeaponData rifleData;
    [SerializeField] private WeaponData shotgunData;
    
    [Header("Ammo System")]
    [SerializeField] private int currentAmmo;
    [SerializeField] private bool hasRifle = false;
    [SerializeField] private bool hasShotgun = false;
    
    [Header("Reserve Ammo System - NEW")]
    [SerializeField] private bool infiniteAmmo = false; // Toggle untuk unlimited ammo (cheat/debug)
    [SerializeField] private int handgunReserveAmmo = 0; // Jumlah PELURU cadangan untuk handgun
    [SerializeField] private int rifleReserveAmmo = 0; // Jumlah PELURU cadangan untuk rifle
    [SerializeField] private int shotgunReserveAmmo = 0; // Jumlah PELURU cadangan untuk shotgun
    [SerializeField] private int maxReserveAmmo = 999; // Max reserve ammo per weapon type
    
    private float lastFireTime = -999f;
    private bool isReloading = false;
    
    void Start()
    {
        // Default weapon: Handgun
        if (currentWeapon == null && handgunData != null)
        {
            currentWeapon = handgunData;
        }
        
        if (currentWeapon != null)
        {
            currentAmmo = currentWeapon.magazineSize;
            
            // Set WeaponType parameter di animator saat start
            if (animator != null)
            {
                // Set initial weapon type dengan INT parameter
                UpdateAnimatorWeaponType();
            }
        }
    }
    
    void Update()
    {
        HandleWeaponInput();
        HandleWeaponSwitch();
    }
    
    private void HandleWeaponInput()
    {
        if (currentWeapon == null || isReloading)
        {
            return;
        }
        
        // Check fire input
        bool fireInput = currentWeapon.isAutomatic 
            ? Input.GetButton("Fire1") // Hold untuk automatic
            : Input.GetButtonDown("Fire1"); // Click untuk semi-auto
        
        // Alternative: pakai key tertentu
        // fireInput = Input.GetKeyDown(KeyCode.Space);
        
        if (fireInput && CanFire())
        {
            Fire();
        }
        
        // Reload
        if (Input.GetKeyDown(KeyCode.R))
        {
            Reload();
        }
    }
    
    private void HandleWeaponSwitch()
    {
        // Switch weapon dengan number keys
        if (Input.GetKeyDown(KeyCode.Alpha1) && handgunData != null)
        {
            SwitchWeapon(handgunData);
        }
        else if (Input.GetKeyDown(KeyCode.Alpha2) && hasRifle && rifleData != null)
        {
            SwitchWeapon(rifleData);
        }
        else if (Input.GetKeyDown(KeyCode.Alpha3) && hasShotgun && shotgunData != null)
        {
            SwitchWeapon(shotgunData);
        }
    }
    
    private bool CanFire()
    {
        return currentAmmo > 0 && Time.time >= lastFireTime + currentWeapon.fireRate;
    }
    
    private void Fire()
    {
        lastFireTime = Time.time;
        currentAmmo--;
        
        // NEW: Trigger event untuk UI update
        OnCurrentAmmoChanged?.Invoke(currentAmmo);
        
        // Trigger animation berdasarkan weapon type
        if (animator != null)
        {
            animator.SetTrigger(currentWeapon.shootAnimationTrigger);
        }
        
        // Shoot bullets (shotgun bisa multiple bullets)
        if (currentWeapon.bulletsPerShot > 1)
        {
            StartCoroutine(FireMultipleBullets());
        }
        else
        {
            ShootBullet(0);
        }
        
        // Auto reload jika ammo habis
        if (currentAmmo <= 0)
        {
            Reload();
        }
        
        // NEW: Notify current ammo changed
        OnCurrentAmmoChanged?.Invoke(currentAmmo);
    }
    
    private System.Collections.IEnumerator FireMultipleBullets()
    {
        for (int i = 0; i < currentWeapon.bulletsPerShot; i++)
        {
            ShootBullet(i);
            
            if (i < currentWeapon.bulletsPerShot - 1)
            {
                yield return new WaitForSeconds(0.01f);
            }
        }
    }
    
    private void ShootBullet(int bulletIndex)
    {
        Vector2 shootDirection = GetShootDirection();
        
        if (currentWeapon.bulletsPerShot > 1)
        {
            float spreadOffset = UnityEngine.Random.Range(-currentWeapon.spreadAngle, currentWeapon.spreadAngle);
            shootDirection = Quaternion.Euler(0, 0, spreadOffset) * shootDirection;
        }
        
        Vector3 spawnPosition = firePoint != null ? firePoint.position : transform.position;
        
        if (currentWeapon.bulletsPerShot > 1)
        {
            Vector2 randomOffset = UnityEngine.Random.insideUnitCircle * 0.1f;
            spawnPosition += new Vector3(randomOffset.x, randomOffset.y, 0);
        }
        
        if (bulletIndex == 0)
        {
            GameObject flashPrefab = GetMuzzleFlashPrefab();
            
            if (flashPrefab != null)
            {
                Vector3 flashPosition = firePoint != null ? firePoint.position : transform.position;
                GameObject muzzleFlash = Instantiate(flashPrefab, flashPosition, Quaternion.identity);
                
                if (muzzleFlash != null)
                {
                    float angle = Mathf.Atan2(shootDirection.y, shootDirection.x) * Mathf.Rad2Deg;
                    muzzleFlash.transform.rotation = Quaternion.Euler(0, 0, angle);
                    Destroy(muzzleFlash, 0.2f);
                }
            }
        }
        
        if (usePhysicalBullets && bulletPrefab != null)
        {
            GameObject bulletObj = Instantiate(bulletPrefab, spawnPosition, Quaternion.identity);
            
            if (bulletObj != null)
            {
                Bullet bullet = bulletObj.GetComponent<Bullet>();
                if (bullet != null)
                {
                    bullet.Initialize(shootDirection, currentWeapon.damage, bulletHitLayers, currentWeapon.range);
                }
                else
                {
                    Destroy(bulletObj);
                }
            }
        }
        else
        {
            RaycastHit2D hit = Physics2D.Raycast(spawnPosition, shootDirection, currentWeapon.range, bulletHitLayers);
            
            if (hit.collider != null)
            {
                Debug.DrawLine(spawnPosition, hit.point, Color.red, 0.1f);
                
                if (hit.collider.CompareTag("Enemy"))
                {
                    ZombieHealth zombieHealth = hit.collider.GetComponent<ZombieHealth>();
                    if (zombieHealth != null)
                    {
                        zombieHealth.TakeDamage(currentWeapon.damage);
                    }
                }
            }
            else
            {
                Debug.DrawLine(spawnPosition, spawnPosition + (Vector3)shootDirection * currentWeapon.range, Color.yellow, 0.1f);
            }
        }
    }
    
    private GameObject GetMuzzleFlashPrefab()
    {
        if (currentWeapon == null)
        {
            return null;
        }
        
        switch (currentWeapon.weaponType)
        {
            case WeaponType.Handgun:
                return handgunMuzzleFlash;
            case WeaponType.Rifle:
                return rifleMuzzleFlash;
            case WeaponType.Shotgun:
                return shotgunMuzzleFlash;
            default:
                return null;
        }
    }
    
    private Vector2 GetShootDirection()
    {
        Vector2 direction = transform.right;
        return direction;
    }
    
    private void Reload()
    {
        if (isReloading || currentAmmo == currentWeapon.magazineSize)
        {
            return;
        }
        
        // NEW: Cek apakah punya reserve ammo (kecuali infinite ammo mode)
        if (!infiniteAmmo && GetReserveAmmoForType(currentWeapon.weaponType) <= 0)
        {
            Debug.Log("No reserve ammo available!");
            return;
        }
        
        StartCoroutine(ReloadCoroutine());
    }
    
    private System.Collections.IEnumerator ReloadCoroutine()
    {
        isReloading = true;
        
        if (animator != null)
        {
            animator.SetTrigger("Reload");
        }
        
        yield return new WaitForSeconds(currentWeapon.reloadTime);
        
        if (infiniteAmmo)
        {
            currentAmmo = currentWeapon.magazineSize;
        }
        else
        {
            // NEW: Ammo-based reload - ambil peluru dari reserve
            int neededAmmo = currentWeapon.magazineSize - currentAmmo; // Berapa peluru yang dibutuhkan
            int reserveAmmo = GetReserveAmmoForType(currentWeapon.weaponType);
            
            if (reserveAmmo > 0)
            {
                // Ambil ammo sebanyak yang dibutuhkan atau sebanyak yang tersedia
                int ammoToTake = Mathf.Min(neededAmmo, reserveAmmo);
                currentAmmo += ammoToTake;
                
                // Kurangi reserve ammo
                switch (currentWeapon.weaponType)
                {
                    case WeaponType.Handgun:
                        handgunReserveAmmo -= ammoToTake;
                        Debug.Log($"Reloaded Handgun with {ammoToTake} bullets. Reserve left: {handgunReserveAmmo}");
                        OnReserveAmmoChanged?.Invoke(WeaponType.Handgun, handgunReserveAmmo);
                        break;
                    case WeaponType.Rifle:
                        rifleReserveAmmo -= ammoToTake;
                        Debug.Log($"Reloaded Rifle with {ammoToTake} bullets. Reserve left: {rifleReserveAmmo}");
                        OnReserveAmmoChanged?.Invoke(WeaponType.Rifle, rifleReserveAmmo);
                        break;
                    case WeaponType.Shotgun:
                        shotgunReserveAmmo -= ammoToTake;
                        Debug.Log($"Reloaded Shotgun with {ammoToTake} bullets. Reserve left: {shotgunReserveAmmo}");
                        OnReserveAmmoChanged?.Invoke(WeaponType.Shotgun, shotgunReserveAmmo);
                        break;
                }
                
                OnCurrentAmmoChanged?.Invoke(currentAmmo);
            }
            else
            {
                Debug.Log("No reserve ammo to reload!");
            }
        }
        
        isReloading = false;
    }
    
    public void SwitchWeapon(WeaponData newWeapon)
    {
        if (newWeapon == null || newWeapon == currentWeapon)
        {
            return;
        }
        
        currentWeapon = newWeapon;
        currentAmmo = currentWeapon.magazineSize;
        isReloading = false;
        
        UpdateAnimatorWeaponType();
        
        Debug.Log($"Switched to {currentWeapon.weaponName} (WeaponType: {(int)currentWeapon.weaponType})");
        
        OnWeaponSwitched?.Invoke(currentWeapon);
        OnCurrentAmmoChanged?.Invoke(currentAmmo);
    }
    
    private void UpdateAnimatorWeaponType()
    {
        if (animator == null || currentWeapon == null)
        {
            return;
        }
        
        int weaponTypeValue = (int)currentWeapon.weaponType;
        animator.SetInteger("WeaponType", weaponTypeValue);
        
        Debug.Log($"Updated Animator WeaponType to: {weaponTypeValue} ({currentWeapon.weaponName})");
    }
    
    public void UnlockRifle()
    {
        hasRifle = true;
        SwitchWeapon(rifleData);
    }
    
    public void UnlockShotgun()
    {
        hasShotgun = true;
        SwitchWeapon(shotgunData);
    }
    
    // NEW: Method untuk add reserve ammo (dipanggil dari ItemPickup)
    // Saat pickup 1 magazine, akan menambahkan peluru sesuai magazineSize weapon
    public void AddAmmoFromMagazine(WeaponType weaponType, int magazineCount = 1)
    {
        WeaponData weaponData = GetWeaponData(weaponType);
        if (weaponData == null)
        {
            Debug.LogWarning($"[WeaponController] WeaponData for {weaponType} not found!");
            return;
        }
        
        // Hitung jumlah peluru dari magazine
        int ammoToAdd = magazineCount * weaponData.magazineSize;
        
        switch (weaponType)
        {
            case WeaponType.Handgun:
                handgunReserveAmmo = Mathf.Min(handgunReserveAmmo + ammoToAdd, maxReserveAmmo);
                Debug.Log($"Added {ammoToAdd} Handgun ammo ({magazineCount} mag x {weaponData.magazineSize}). Reserve: {handgunReserveAmmo}");
                OnReserveAmmoChanged?.Invoke(WeaponType.Handgun, handgunReserveAmmo);
                break;
            case WeaponType.Rifle:
                rifleReserveAmmo = Mathf.Min(rifleReserveAmmo + ammoToAdd, maxReserveAmmo);
                Debug.Log($"Added {ammoToAdd} Rifle ammo ({magazineCount} mag x {weaponData.magazineSize}). Reserve: {rifleReserveAmmo}");
                OnReserveAmmoChanged?.Invoke(WeaponType.Rifle, rifleReserveAmmo);
                break;
            case WeaponType.Shotgun:
                shotgunReserveAmmo = Mathf.Min(shotgunReserveAmmo + ammoToAdd, maxReserveAmmo);
                Debug.Log($"Added {ammoToAdd} Shotgun ammo ({magazineCount} mag x {weaponData.magazineSize}). Reserve: {shotgunReserveAmmo}");
                OnReserveAmmoChanged?.Invoke(WeaponType.Shotgun, shotgunReserveAmmo);
                break;
        }
        
        // Force UI update
        if (InventoryUI.Instance != null)
        {
            InventoryUI.Instance.ForceUpdateUI();
        }
    }
    
    // DEPRECATED: Old AddMagazine method - redirect to AddAmmoFromMagazine
    public void AddMagazine(WeaponType weaponType, int magazineCount = 1)
    {
        AddAmmoFromMagazine(weaponType, magazineCount);
    }
    
    // Method untuk add ammo langsung (jumlah peluru, bukan magazine)
    public void AddAmmo(WeaponType weaponType, int amount)
    {
        switch (weaponType)
        {
            case WeaponType.Handgun:
                handgunReserveAmmo = Mathf.Min(handgunReserveAmmo + amount, maxReserveAmmo);
                Debug.Log($"Added {amount} Handgun ammo directly. Reserve: {handgunReserveAmmo}");
                OnReserveAmmoChanged?.Invoke(WeaponType.Handgun, handgunReserveAmmo);
                break;
            case WeaponType.Rifle:
                rifleReserveAmmo = Mathf.Min(rifleReserveAmmo + amount, maxReserveAmmo);
                Debug.Log($"Added {amount} Rifle ammo directly. Reserve: {rifleReserveAmmo}");
                OnReserveAmmoChanged?.Invoke(WeaponType.Rifle, rifleReserveAmmo);
                break;
            case WeaponType.Shotgun:
                shotgunReserveAmmo = Mathf.Min(shotgunReserveAmmo + amount, maxReserveAmmo);
                Debug.Log($"Added {amount} Shotgun ammo directly. Reserve: {shotgunReserveAmmo}");
                OnReserveAmmoChanged?.Invoke(WeaponType.Shotgun, shotgunReserveAmmo);
                break;
        }
        
        if (InventoryUI.Instance != null)
        {
            InventoryUI.Instance.ForceUpdateUI();
        }
    }
    
    private WeaponData GetWeaponData(WeaponType weaponType)
    {
        switch (weaponType)
        {
            case WeaponType.Handgun:
                return handgunData;
            case WeaponType.Rifle:
                return rifleData;
            case WeaponType.Shotgun:
                return shotgunData;
            default:
                return null;
        }
    }
    
    // Getters
    public WeaponData GetCurrentWeapon()
    {
        return currentWeapon;
    }
    
    public int GetCurrentAmmo()
    {
        return currentAmmo;
    }
    
    public bool IsReloading()
    {
        return isReloading;
    }
    
    // NEW: Get reserve ammo untuk current weapon
    public int GetReserveAmmo()
    {
        if (currentWeapon == null)
        {
            return 0;
        }
        
        return GetReserveAmmoForType(currentWeapon.weaponType);
    }
    
    // NEW: Get reserve ammo untuk specific weapon type (untuk UI)
    public int GetReserveAmmoForType(WeaponType weaponType)
    {
        switch (weaponType)
        {
            case WeaponType.Handgun:
                return handgunReserveAmmo;
            case WeaponType.Rifle:
                return rifleReserveAmmo;
            case WeaponType.Shotgun:
                return shotgunReserveAmmo;
            default:
                return 0;
        }
    }
    
    // DEPRECATED: Keep for compatibility - now returns actual reserve ammo
    public int GetMagazineCount()
    {
        if (currentWeapon == null)
        {
            return 0;
        }
        
        // Return berapa magazine yang bisa di-reload dari reserve
        int reserve = GetReserveAmmoForType(currentWeapon.weaponType);
        return Mathf.FloorToInt((float)reserve / currentWeapon.magazineSize);
    }
    
    // DEPRECATED: Keep for compatibility
    public int GetMagazineCountForType(WeaponType weaponType)
    {
        WeaponData weaponData = GetWeaponData(weaponType);
        if (weaponData == null)
        {
            return 0;
        }
        
        int reserve = GetReserveAmmoForType(weaponType);
        return Mathf.FloorToInt((float)reserve / weaponData.magazineSize);
    }
}
