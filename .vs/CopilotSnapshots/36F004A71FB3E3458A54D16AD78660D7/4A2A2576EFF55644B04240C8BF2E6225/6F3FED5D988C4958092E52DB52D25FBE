using UnityEngine;
using UnityEngine.UI;
using TMPro;

public class InventoryUI : MonoBehaviour
{
    [Header("References")]
    [SerializeField] private PlayerInventory playerInventory;
    [SerializeField] private WeaponController weaponController;
    
    [Header("Medkit UI")]
    [SerializeField] private TextMeshProUGUI medkitText;
    [SerializeField] private Image medkitIcon;
    
    [Header("Handgun Ammo UI")]
    [SerializeField] private TextMeshProUGUI handgunAmmoText;
    [SerializeField] private Image handgunAmmoIcon;
    
    [Header("Rifle Ammo UI")]
    [SerializeField] private TextMeshProUGUI rifleAmmoText;
    [SerializeField] private Image rifleAmmoIcon;
    
    [Header("Shotgun Ammo UI")]
    [SerializeField] private TextMeshProUGUI shotgunAmmoText;
    [SerializeField] private Image shotgunAmmoIcon;
    
    [Header("Current Weapon Display")]
    [SerializeField] private TextMeshProUGUI currentWeaponText;
    [SerializeField] private TextMeshProUGUI currentAmmoText;
    
    [Header("UI Settings")]
    [SerializeField] private Color lowAmmoColor = Color.red;
    [SerializeField] private Color normalAmmoColor = Color.white;
    [SerializeField] private int lowAmmoThreshold = 10;
    [SerializeField] private float dimmedAlpha = 0.3f;
    
    private static InventoryUI instance;
    public static InventoryUI Instance => instance;
    
    // Cache nilai sebelumnya untuk debug
    private int lastHandgunAmmo = -1;
    private int lastRifleAmmo = -1;
    private int lastShotgunAmmo = -1;
    
    void Awake()
    {
        instance = this;
    }
    
    void Start()
    {
        // PENTING: Gunakan singleton WeaponController, bukan FindFirstObjectByType
        if (weaponController == null)
            weaponController = WeaponController.Instance;
        
        // Fallback jika singleton belum ready
        if (weaponController == null)
            weaponController = FindFirstObjectByType<WeaponController>();
        
        if (playerInventory == null)
            playerInventory = FindFirstObjectByType<PlayerInventory>();
        
        Debug.Log($"[InventoryUI] Start - WeaponController: {(weaponController != null ? "OK" : "NULL")}");
        Debug.Log($"[InventoryUI] HandgunText: {(handgunAmmoText != null ? "OK" : "NULL")}");
        
        // Subscribe to events sebagai backup
        if (playerInventory != null)
            playerInventory.OnMedkitChanged += OnMedkitChanged;
        
        if (weaponController != null)
        {
            weaponController.OnReserveAmmoChanged += OnReserveAmmoChanged;
            weaponController.OnWeaponSwitched += OnWeaponSwitched;
            weaponController.OnCurrentAmmoChanged += OnCurrentAmmoChanged;
        }
    }
    
    void Update()
    {
        // Re-acquire reference jika null (bisa terjadi jika timing berbeda)
        if (weaponController == null)
        {
            weaponController = WeaponController.Instance;
            if (weaponController != null)
            {
                Debug.Log("[InventoryUI] WeaponController acquired in Update!");
            }
        }
        
        UpdateAllUI();
    }
    
    private void UpdateAllUI()
    {
        UpdateMedkitUI();
        UpdateAmmoUI();
        UpdateCurrentWeaponUI();
    }
    
    private void UpdateMedkitUI()
    {
        if (playerInventory == null || medkitText == null) return;
        
        int count = playerInventory.GetCurrentMedkits();
        medkitText.text = $"x {count:00}";
        medkitText.color = count == 0 ? lowAmmoColor : normalAmmoColor;
        
        if (medkitIcon != null)
        {
            Color c = medkitIcon.color;
            c.a = count > 0 ? 1f : dimmedAlpha;
            medkitIcon.color = c;
        }
    }
    
    private void UpdateAmmoUI()
    {
        if (weaponController == null) return;
        
        // Handgun
        int handgunAmmo = weaponController.GetReserveAmmoForType(WeaponType.Handgun);
        if (handgunAmmoText != null)
        {
            handgunAmmoText.text = $"x {handgunAmmo:000}";
            handgunAmmoText.color = handgunAmmo <= lowAmmoThreshold ? lowAmmoColor : normalAmmoColor;
            
            // Debug: log jika nilai berubah
            if (handgunAmmo != lastHandgunAmmo)
            {
                Debug.Log($"[InventoryUI] Handgun ammo changed: {lastHandgunAmmo} -> {handgunAmmo}");
                lastHandgunAmmo = handgunAmmo;
            }
        }
        if (handgunAmmoIcon != null)
        {
            Color c = handgunAmmoIcon.color;
            c.a = handgunAmmo > 0 ? 1f : dimmedAlpha;
            handgunAmmoIcon.color = c;
        }
        
        // Rifle
        int rifleAmmo = weaponController.GetReserveAmmoForType(WeaponType.Rifle);
        if (rifleAmmoText != null)
        {
            rifleAmmoText.text = $"x {rifleAmmo:000}";
            rifleAmmoText.color = rifleAmmo <= lowAmmoThreshold ? lowAmmoColor : normalAmmoColor;
            
            if (rifleAmmo != lastRifleAmmo)
            {
                Debug.Log($"[InventoryUI] Rifle ammo changed: {lastRifleAmmo} -> {rifleAmmo}");
                lastRifleAmmo = rifleAmmo;
            }
        }
        if (rifleAmmoIcon != null)
        {
            Color c = rifleAmmoIcon.color;
            c.a = rifleAmmo > 0 ? 1f : dimmedAlpha;
            rifleAmmoIcon.color = c;
        }
        
        // Shotgun
        int shotgunAmmo = weaponController.GetReserveAmmoForType(WeaponType.Shotgun);
        if (shotgunAmmoText != null)
        {
            shotgunAmmoText.text = $"x {shotgunAmmo:000}";
            shotgunAmmoText.color = shotgunAmmo <= lowAmmoThreshold ? lowAmmoColor : normalAmmoColor;
            
            if (shotgunAmmo != lastShotgunAmmo)
            {
                Debug.Log($"[InventoryUI] Shotgun ammo changed: {lastShotgunAmmo} -> {shotgunAmmo}");
                lastShotgunAmmo = shotgunAmmo;
            }
        }
        if (shotgunAmmoIcon != null)
        {
            Color c = shotgunAmmoIcon.color;
            c.a = shotgunAmmo > 0 ? 1f : dimmedAlpha;
            shotgunAmmoIcon.color = c;
        }
    }
    
    private void UpdateCurrentWeaponUI()
    {
        if (weaponController == null) return;
        
        WeaponData weapon = weaponController.GetCurrentWeapon();
        if (weapon == null) return;
        
        if (currentWeaponText != null)
            currentWeaponText.text = weapon.weaponName.ToUpper();
        
        if (currentAmmoText != null)
        {
            int current = weaponController.GetCurrentAmmo();
            int reserve = weaponController.GetReserveAmmo();
            currentAmmoText.text = $"{current} / {reserve}";
            currentAmmoText.color = current <= lowAmmoThreshold ? lowAmmoColor : normalAmmoColor;
        }
    }
    
    // Event handlers
    private void OnMedkitChanged(int count)
    {
        Debug.Log($"[InventoryUI] EVENT: Medkit changed to {count}");
        UpdateMedkitUI();
    }
    
    private void OnReserveAmmoChanged(WeaponType type, int amount)
    {
        Debug.Log($"[InventoryUI] EVENT: {type} reserve changed to {amount}");
        UpdateAmmoUI();
    }
    
    private void OnWeaponSwitched(WeaponData weapon) => UpdateAllUI();
    private void OnCurrentAmmoChanged(int amount) => UpdateCurrentWeaponUI();
    
    // Flash effects
    public void FlashMedkitIcon()
    {
        if (medkitIcon != null) StartCoroutine(FlashIcon(medkitIcon));
    }
    
    public void FlashHandgunAmmoIcon()
    {
        Debug.Log("[InventoryUI] FlashHandgunAmmoIcon called");
        if (handgunAmmoIcon != null) StartCoroutine(FlashIcon(handgunAmmoIcon));
    }
    
    public void FlashRifleAmmoIcon()
    {
        Debug.Log("[InventoryUI] FlashRifleAmmoIcon called");
        if (rifleAmmoIcon != null) StartCoroutine(FlashIcon(rifleAmmoIcon));
    }
    
    public void FlashShotgunAmmoIcon()
    {
        Debug.Log("[InventoryUI] FlashShotgunAmmoIcon called");
        if (shotgunAmmoIcon != null) StartCoroutine(FlashIcon(shotgunAmmoIcon));
    }
    
    private System.Collections.IEnumerator FlashIcon(Image icon)
    {
        Color original = icon.color;
        Color flash = Color.green;
        flash.a = original.a;
        
        for (int i = 0; i < 3; i++)
        {
            icon.color = flash;
            yield return new WaitForSeconds(0.1f);
            icon.color = original;
            yield return new WaitForSeconds(0.1f);
        }
    }
    
    public void ForceUpdateUI() => UpdateAllUI();
    public void DirectUpdateAmmoText(WeaponType weaponType, int reserveAmmo) => UpdateAmmoUI();
    
    void OnDestroy()
    {
        if (playerInventory != null)
            playerInventory.OnMedkitChanged -= OnMedkitChanged;
        
        if (weaponController != null)
        {
            weaponController.OnReserveAmmoChanged -= OnReserveAmmoChanged;
            weaponController.OnWeaponSwitched -= OnWeaponSwitched;
            weaponController.OnCurrentAmmoChanged -= OnCurrentAmmoChanged;
        }
    }
}
