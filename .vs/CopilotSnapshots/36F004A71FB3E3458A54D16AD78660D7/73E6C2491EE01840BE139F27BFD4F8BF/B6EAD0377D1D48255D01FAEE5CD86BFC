using UnityEngine;
using UnityEngine.UI;
using TMPro;

public class InventoryUI : MonoBehaviour
{
    [Header("References")]
    [SerializeField] private PlayerInventory playerInventory;
    [SerializeField] private WeaponController weaponController;
    
    [Header("Medkit UI")]
    [SerializeField] private TextMeshProUGUI medkitText;
    [SerializeField] private Image medkitIcon;
    
    [Header("Handgun Ammo UI")]
    [SerializeField] private TextMeshProUGUI handgunAmmoText;
    [SerializeField] private Image handgunAmmoIcon;
    
    [Header("Rifle Ammo UI")]
    [SerializeField] private TextMeshProUGUI rifleAmmoText;
    [SerializeField] private Image rifleAmmoIcon;
    
    [Header("Shotgun Ammo UI")]
    [SerializeField] private TextMeshProUGUI shotgunAmmoText;
    [SerializeField] private Image shotgunAmmoIcon;
    
    [Header("Current Weapon Display (Optional)")]
    [SerializeField] private TextMeshProUGUI currentWeaponText;
    [SerializeField] private TextMeshProUGUI currentAmmoText;
    
    [Header("UI Settings")]
    [SerializeField] private bool autoFindReferences = true;
    [SerializeField] private Color lowAmmoColor = Color.red;
    [SerializeField] private Color normalAmmoColor = Color.white;
    [SerializeField] private int lowAmmoThreshold = 10;
    [SerializeField] private float dimmedAlpha = 0.3f;
    
    [Header("Debug")]
    [SerializeField] private bool showDebugLogs = false;
    [SerializeField] private bool showUpdateLogs = false;
    
    private float lastLogTime = 0f;
    
    private static InventoryUI instance;
    public static InventoryUI Instance => instance;
    
    void Awake()
    {
        if (instance == null)
        {
            instance = this;
        }
        else if (instance != this)
        {
            Debug.LogWarning("Multiple InventoryUI instances detected!");
        }
    }
    
    void Start()
    {
        FindReferences();
        
        if (playerInventory == null)
        {
            Debug.LogWarning("InventoryUI: PlayerInventory not found!");
        }
        
        if (weaponController == null)
        {
            Debug.LogWarning("InventoryUI: WeaponController not found!");
        }
        
        // Subscribe to events
        if (playerInventory != null)
        {
            playerInventory.OnMedkitChanged += UpdateMedkitUI;
        }
        
        if (weaponController != null)
        {
            weaponController.OnReserveAmmoChanged += OnReserveAmmoChangedHandler;
            weaponController.OnWeaponSwitched += OnWeaponSwitchedHandler;
            weaponController.OnCurrentAmmoChanged += OnCurrentAmmoChangedHandler;
        }
        
        // DEBUG: Log semua text references
        Debug.Log("=== InventoryUI TEXT REFERENCES CHECK ===");
        Debug.Log($"Handgun Text: {(handgunAmmoText != null ? handgunAmmoText.gameObject.name : "NULL")}");
        Debug.Log($"Rifle Text: {(rifleAmmoText != null ? rifleAmmoText.gameObject.name : "NULL")}");
        Debug.Log($"Shotgun Text: {(shotgunAmmoText != null ? shotgunAmmoText.gameObject.name : "NULL")}");
        Debug.Log($"Medkit Text: {(medkitText != null ? medkitText.gameObject.name : "NULL")}");
        
        Debug.Log("[InventoryUI] Starting... Forcing first update");
        UpdateAllUI();
    }
    
    public void FindReferences()
    {
        if (autoFindReferences)
        {
            if (playerInventory == null)
            {
                playerInventory = FindObjectOfType<PlayerInventory>();
            }
            
            if (weaponController == null)
            {
                weaponController = FindObjectOfType<WeaponController>();
            }
        }
    }
    
    void Update()
    {
        UpdateCurrentWeaponUI();
        
        if (showUpdateLogs && Time.time - lastLogTime > 2f)
        {
            lastLogTime = Time.time;
            if (weaponController != null)
            {
                Debug.Log($"[InventoryUI] Reserve ammo: H={weaponController.GetReserveAmmoForType(WeaponType.Handgun)}, R={weaponController.GetReserveAmmoForType(WeaponType.Rifle)}, S={weaponController.GetReserveAmmoForType(WeaponType.Shotgun)}");
            }
        }
    }
    
    public void ForceUpdateUI()
    {
        if (playerInventory == null || weaponController == null)
        {
            FindReferences();
        }
        
        Debug.Log("[InventoryUI] ForceUpdateUI() called - updating all UI now");
        UpdateAllUI();
    }
    
    private void UpdateAllUI()
    {
        UpdateMedkitUI();
        UpdateHandgunAmmoUI();
        UpdateRifleAmmoUI();
        UpdateShotgunAmmoUI();
        UpdateCurrentWeaponUI();
    }
    
    // ============================================
    // MEDKIT UI
    // ============================================
    private void UpdateMedkitUI()
    {
        if (playerInventory == null) return;
        
        if (medkitText != null)
        {
            int current = playerInventory.GetCurrentMedkits();
            medkitText.text = $"x {current:00}";
            medkitText.color = current == 0 ? lowAmmoColor : normalAmmoColor;
        }
        
        if (medkitIcon != null)
        {
            Color iconColor = medkitIcon.color;
            iconColor.a = playerInventory.GetCurrentMedkits() > 0 ? 1f : dimmedAlpha;
            medkitIcon.color = iconColor;
        }
    }
    
    private void UpdateMedkitUI(int newCount)
    {
        if (medkitText != null)
        {
            medkitText.text = $"x {newCount:00}";
            medkitText.color = newCount == 0 ? lowAmmoColor : normalAmmoColor;
        }
        
        if (medkitIcon != null)
        {
            Color iconColor = medkitIcon.color;
            iconColor.a = newCount > 0 ? 1f : dimmedAlpha;
            medkitIcon.color = iconColor;
        }
    }
    
    // ============================================
    // HANDGUN AMMO UI
    // ============================================
    private void UpdateHandgunAmmoUI()
    {
        if (weaponController == null) return;
        int reserveAmmo = weaponController.GetReserveAmmoForType(WeaponType.Handgun);
        UpdateHandgunAmmoUI(reserveAmmo);
    }
    
    private void UpdateHandgunAmmoUI(int reserveAmmo)
    {
        if (handgunAmmoText != null)
        {
            handgunAmmoText.text = $"x {reserveAmmo:000}";
            handgunAmmoText.color = reserveAmmo <= lowAmmoThreshold ? lowAmmoColor : normalAmmoColor;
            Debug.Log($"[InventoryUI] Handgun UI SET to: x {reserveAmmo:000}");
        }
        else
        {
            Debug.LogError("[InventoryUI] handgunAmmoText is NULL! Cannot update UI.");
        }
        
        if (handgunAmmoIcon != null)
        {
            Color iconColor = handgunAmmoIcon.color;
            iconColor.a = reserveAmmo > 0 ? 1f : dimmedAlpha;
            handgunAmmoIcon.color = iconColor;
        }
    }
    
    // ============================================
    // RIFLE AMMO UI
    // ============================================
    private void UpdateRifleAmmoUI()
    {
        if (weaponController == null) return;
        int reserveAmmo = weaponController.GetReserveAmmoForType(WeaponType.Rifle);
        UpdateRifleAmmoUI(reserveAmmo);
    }
    
    private void UpdateRifleAmmoUI(int reserveAmmo)
    {
        if (rifleAmmoText != null)
        {
            rifleAmmoText.text = $"x {reserveAmmo:000}";
            rifleAmmoText.color = reserveAmmo <= lowAmmoThreshold ? lowAmmoColor : normalAmmoColor;
            Debug.Log($"[InventoryUI] Rifle UI SET to: x {reserveAmmo:000}");
        }
        else
        {
            Debug.LogError("[InventoryUI] rifleAmmoText is NULL! Cannot update UI.");
        }
        
        if (rifleAmmoIcon != null)
        {
            Color iconColor = rifleAmmoIcon.color;
            iconColor.a = reserveAmmo > 0 ? 1f : dimmedAlpha;
            rifleAmmoIcon.color = iconColor;
        }
    }
    
    // ============================================
    // SHOTGUN AMMO UI
    // ============================================
    private void UpdateShotgunAmmoUI()
    {
        if (weaponController == null) return;
        int reserveAmmo = weaponController.GetReserveAmmoForType(WeaponType.Shotgun);
        UpdateShotgunAmmoUI(reserveAmmo);
    }
    
    private void UpdateShotgunAmmoUI(int reserveAmmo)
    {
        if (shotgunAmmoText != null)
        {
            shotgunAmmoText.text = $"x {reserveAmmo:000}";
            shotgunAmmoText.color = reserveAmmo <= lowAmmoThreshold ? lowAmmoColor : normalAmmoColor;
            Debug.Log($"[InventoryUI] Shotgun UI SET to: x {reserveAmmo:000}");
        }
        else
        {
            Debug.LogError("[InventoryUI] shotgunAmmoText is NULL! Cannot update UI.");
        }
        
        if (shotgunAmmoIcon != null)
        {
            Color iconColor = shotgunAmmoIcon.color;
            iconColor.a = reserveAmmo > 0 ? 1f : dimmedAlpha;
            shotgunAmmoIcon.color = iconColor;
        }
    }
    
    // ============================================
    // CURRENT WEAPON UI
    // ============================================
    private void UpdateCurrentWeaponUI()
    {
        if (weaponController == null) return;
        
        WeaponData currentWeapon = weaponController.GetCurrentWeapon();
        if (currentWeapon == null) return;
        
        if (currentWeaponText != null)
        {
            currentWeaponText.text = currentWeapon.weaponName.ToUpper();
        }
        
        if (currentAmmoText != null)
        {
            int currentAmmo = weaponController.GetCurrentAmmo();
            int reserveAmmo = weaponController.GetReserveAmmo();
            currentAmmoText.text = $"{currentAmmo} / {reserveAmmo}";
            currentAmmoText.color = (currentAmmo <= lowAmmoThreshold || currentAmmo == 0) ? lowAmmoColor : normalAmmoColor;
        }
    }
    
    // ============================================
    // EVENT HANDLERS
    // ============================================
    
    private void OnReserveAmmoChangedHandler(WeaponType weaponType, int newReserveAmmo)
    {
        Debug.Log($"[InventoryUI] EVENT RECEIVED: {weaponType} reserve = {newReserveAmmo}");
        
        switch (weaponType)
        {
            case WeaponType.Handgun:
                UpdateHandgunAmmoUI(newReserveAmmo);
                break;
            case WeaponType.Rifle:
                UpdateRifleAmmoUI(newReserveAmmo);
                break;
            case WeaponType.Shotgun:
                UpdateShotgunAmmoUI(newReserveAmmo);
                break;
        }
    }
    
    private void OnWeaponSwitchedHandler(WeaponData newWeapon)
    {
        UpdateHandgunAmmoUI();
        UpdateRifleAmmoUI();
        UpdateShotgunAmmoUI();
        UpdateCurrentWeaponUI();
    }
    
    private void OnCurrentAmmoChangedHandler(int newAmmo)
    {
        UpdateCurrentWeaponUI();
    }
    
    // ============================================
    // FLASH EFFECTS
    // ============================================
    
    public void FlashMedkitIcon()
    {
        ForceUpdateUI();
        if (medkitIcon != null) StartCoroutine(FlashIcon(medkitIcon));
    }
    
    public void FlashHandgunAmmoIcon()
    {
        ForceUpdateUI();
        if (handgunAmmoIcon != null) StartCoroutine(FlashIcon(handgunAmmoIcon));
    }
    
    public void FlashRifleAmmoIcon()
    {
        ForceUpdateUI();
        if (rifleAmmoIcon != null) StartCoroutine(FlashIcon(rifleAmmoIcon));
    }
    
    public void FlashShotgunAmmoIcon()
    {
        ForceUpdateUI();
        if (shotgunAmmoIcon != null) StartCoroutine(FlashIcon(shotgunAmmoIcon));
    }
    
    private System.Collections.IEnumerator FlashIcon(Image icon)
    {
        Color original = icon.color;
        Color flash = Color.green;
        flash.a = original.a;
        
        for (int i = 0; i < 3; i++)
        {
            icon.color = flash;
            yield return new WaitForSeconds(0.1f);
            icon.color = original;
            yield return new WaitForSeconds(0.1f);
        }
    }
    
    void OnDestroy()
    {
        if (playerInventory != null)
        {
            playerInventory.OnMedkitChanged -= UpdateMedkitUI;
        }
        
        if (weaponController != null)
        {
            weaponController.OnReserveAmmoChanged -= OnReserveAmmoChangedHandler;
            weaponController.OnWeaponSwitched -= OnWeaponSwitchedHandler;
            weaponController.OnCurrentAmmoChanged -= OnCurrentAmmoChangedHandler;
        }
    }
}
