using UnityEngine;

public class ZombieMovement : MonoBehaviour
{
    [Header("Movement Settings")]
    [SerializeField] private float kecepatan = 2f; // Kecepatan zombie mengejar
    [SerializeField] private float jarakBerhenti = 1.5f; // Jarak minimum untuk berhenti mengejar

    [Header("Detection Settings")]
    [SerializeField] private float detectionRange = 10f; // Jarak deteksi player
    [SerializeField] private bool showDetectionRadius = true; // Tampilkan detection radius di Scene view

    [Header("Attack Settings")]
    [SerializeField] private float attackRange = 1.5f; // Jarak untuk menyerang
    [SerializeField] private float attackCooldown = 1.5f; // Cooldown antara serangan (detik)
    [SerializeField] private int attackDamage = 10; // Damage yang diberikan ke player
    
    [Header("Components")]
    [SerializeField] private Animator animator; // Animator zombie

    private Transform target; // Target player
    private bool isAttacking = false; // Flag untuk mengecek apakah sedang menyerang
    private bool isChasing = false; // Flag untuk mengecek apakah sudah ter-trigger untuk mengejar
    private float lastAttackTime = 0f; // Waktu serangan terakhir

    void Start()
    {

    }

    void Update()
    {
        // Jika sedang menyerang, jangan bergerak
        if (isAttacking)
        {
            return;
        }

        // Cari pemain jika target belum diset
        if (target == null)
        {
            GameObject player = GameObject.FindGameObjectWithTag("Player");
            if (player != null)
            {
                target = player.transform;
            }
            return;
        }

        // Hitung jarak antara zombie dan pemain
        float jarak = Vector3.Distance(transform.position, target.position);

        // Cek apakah player masuk detection range (trigger chase)
        if (!isChasing && jarak <= detectionRange)
        {
            // Trigger chase mode
            isChasing = true;
            Debug.Log(gameObject.name + " detected player! Start chasing...");
        }

        // Jika sudah ter-trigger, terus kejar player
        if (isChasing)
        {
            // Cek apakah dalam jarak serang
            if (jarak <= attackRange)
            {
                TryAttackPlayer();
            }
            else
            {
                ChasePlayer(jarak);
            }
        }
        else
        {
            // Idle jika belum ter-trigger
            if (animator != null)
            {
                animator.SetBool("isRunning", false);
            }
        }
    }

    private void ChasePlayer(float jarak)
    {
        // Jika jarak lebih besar dari jarak berhenti, kejar pemain
        if (jarak > jarakBerhenti)
        {
            // Set animasi berjalan jika ada animator
            if (animator != null)
            {
                animator.SetBool("isRunning", true);
            }

            // Gerakkan zombie menuju pemain
            Vector3 arah = (target.position - transform.position).normalized;
            transform.position += arah * kecepatan * Time.deltaTime;

            // Rotasi zombie menghadap pemain
            RotateTowardsTarget(arah);
        }
        else
        {
            // Set animasi idle jika dekat dengan pemain
            if (animator != null)
            {
                animator.SetBool("isRunning", false);
            }
            
            // Tetap menghadap player meskipun tidak bergerak
            Vector3 arah = (target.position - transform.position).normalized;
            RotateTowardsTarget(arah);
        }
    }

    private void TryAttackPlayer()
    {
        // Berhenti bergerak
        if (animator != null)
        {
            animator.SetBool("isRunning", false);
        }

        // Tetap menghadap player
        Vector3 arah = (target.position - transform.position).normalized;
        RotateTowardsTarget(arah);

        // Cek apakah sudah melewati cooldown
        if (Time.time >= lastAttackTime + attackCooldown)
        {
            Debug.Log($"{gameObject.name} - Ready to attack! (Cooldown passed)");
            PerformAttack();
            lastAttackTime = Time.time;
        }
        else
        {
            Debug.Log($"{gameObject.name} - Waiting for cooldown... ({(lastAttackTime + attackCooldown - Time.time):F2}s remaining)");
        }
    }

    private void PerformAttack()
    {
        // Set flag attacking
        isAttacking = true;

        Debug.Log($"{gameObject.name} - PerformAttack() called!");

        // Trigger animasi attack jika ada
        if (animator != null)
        {
            Debug.Log($"{gameObject.name} - Triggering 'isAttack' animation!");
            animator.SetTrigger("isAttack");
        }
        else
        {
            Debug.LogError($"{gameObject.name} - Animator is NULL! Cannot play attack animation!");
        }

        Debug.Log(gameObject.name + " attacking player!");

        // Berikan damage ke player
        DealDamageToPlayer();

        // Reset attacking flag setelah delay (sesuaikan dengan durasi animasi)
        Invoke("ResetAttackFlag", 1f); // Sesuaikan dengan durasi animasi attack
    }

    private void DealDamageToPlayer()
    {
        if (target != null)
        {
            // Cari komponen PlayerHealth di player
            PlayerHealth playerHealth = target.GetComponent<PlayerHealth>();
            if (playerHealth != null)
            {
                playerHealth.TakeDamage(attackDamage);
            }
            else
            {
                Debug.LogWarning("PlayerHealth component not found on player!");
            }
        }
    }

    private void ResetAttackFlag()
    {
        isAttacking = false;
    }

    void RotateTowardsTarget(Vector3 arah)
    {
        // Hitung sudut rotasi berdasarkan arah
        float angle = Mathf.Atan2(arah.y, arah.x) * Mathf.Rad2Deg;
        transform.rotation = Quaternion.Euler(0f, 0f, angle);
    }

    // Method untuk freeze movement saat menyerang (dipanggil dari Enemy.cs)
    public void SetAttacking(bool attacking)
    {
        isAttacking = attacking;
    }

    // Method untuk reset chase state (opsional, untuk gameplay mechanic tertentu)
    public void ResetChaseState()
    {
        isChasing = false;
        Debug.Log(gameObject.name + " chase reset!");
    }

    // Visualisasi detection range di Scene view (hanya untuk development)
    private void OnDrawGizmosSelected()
    {
        if (showDetectionRadius)
        {
            // Warna hijau untuk detection range
            Gizmos.color = Color.green;
            Gizmos.DrawWireSphere(transform.position, detectionRange);

            // Warna kuning untuk attack range
            Gizmos.color = Color.yellow;
            Gizmos.DrawWireSphere(transform.position, attackRange);

            // Warna merah untuk jarak berhenti
            Gizmos.color = Color.red;
            Gizmos.DrawWireSphere(transform.position, jarakBerhenti);

            // Label
#if UNITY_EDITOR
            UnityEditor.Handles.Label(transform.position + Vector3.up * 2f,
                $"Detection: {detectionRange}m\nAttack: {attackRange}m\nStop: {jarakBerhenti}m");
#endif
        }
    }
}
